---
title: 绘制描红流程图
author: songchen
top: false
cover: false
toc: true
mathjax: false
date: 2023-03-01 20:03:46
img:
coverImg:
password:
summary:
tags:
- 绘图
categories: [Support service component,Process engine,flowable]
---

### 配置 ，避免字体错误 

```java
@Configuration

public class FlowableConfiguration implements EngineConfigurationConfigurer<SpringProcessEngineConfiguration> {

    @Override
    public void configure(SpringProcessEngineConfiguration engineConfiguration) {

        engineConfiguration.setActivityFontName("微软雅黑");

        engineConfiguration.setLabelFontName("微软雅黑");

        engineConfiguration.setAnnotationFontName("微软雅黑");
    }
}
```

### 生成图片 

```java
@Service

public class ProcessDiagramHandler {

    @Resource

    private RuntimeService runtimeService;

  

    @Resource

    private HistoryService historyService;

  

    @Resource

    private RepositoryService repositoryService;

  

    @Resource

    private TaskService taskService;

  

    @Resource

    private ProcessEngine processEngine;

  

    public byte[] showImages(String processInstanceId) {

        String processDefinitionId = null;

        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery()

                .processInstanceId(processInstanceId).singleResult();

  

        if (processInstance == null) {

            HistoricProcessInstance historicProcessInstance = historyService.createHistoricProcessInstanceQuery()

                    .processInstanceId(processInstanceId).singleResult();

            processDefinitionId = historicProcessInstance.getProcessDefinitionId();

        } else {

            processDefinitionId = processInstance.getProcessDefinitionId();

        }

        BpmnModel bpmnModel = repositoryService.getBpmnModel(processDefinitionId);

  

        List<HistoricActivityInstance> historyProcess = historyService // 历史相关Service

                .createHistoricActivityInstanceQuery() // 创建历史活动实例查询

                .processInstanceId(processInstanceId) // 执行流程实例id

                .finished()

                .list();

  

        List<String> activityIds = new ArrayList<>();

        List<String> flows = new ArrayList<>();

        // 获取流程图

        for (HistoricActivityInstance hi : historyProcess) {

            String activityType = hi.getActivityType();

            if (activityType.equals("sequenceFlow")) {

                flows.add(hi.getActivityId());

            } else if (activityType.equals("userTask")

                    || activityType.equals("startEvent")

                    || activityType.equals("endEvent")) {

                activityIds.add(hi.getActivityId());

            }

        }

        Task task = taskService.createTaskQuery().processInstanceId(processInstanceId).singleResult();

        if (task != null) {

            activityIds.add(task.getTaskDefinitionKey());

        }

        ProcessEngineConfiguration engConf = processEngine.getProcessEngineConfiguration();

        // 定义流程画布生成器

        ProcessDiagramGenerator processDiagramGenerator = engConf.getProcessDiagramGenerator();

        ;

        byte[] bytes = null;

        try (InputStream in = processDiagramGenerator.generateDiagram(bpmnModel, "png", activityIds, flows,

                engConf.getActivityFontName(), engConf.getLabelFontName(), engConf.getAnnotationFontName(),

                engConf.getClassLoader(), 1.0, true)) {

            bytes = new byte[in.available()];

            in.read(bytes, 0, in.available());

        } catch (IOException e) {
            e.printStackTrace();
        }
        return bytes;
    }
}
```

### 控制端写数据流 

```java
 @GetMapping(value = "process")
 public void showImages(String processInstanceId, HttpServletResponse response) {
        byte[] buf = processDiagramHandler.showImages(processInstanceId);
        try (OutputStream out = response.getOutputStream()) {
            out.write(buf, 0, buf.length);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
```