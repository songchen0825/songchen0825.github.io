---
title: 单体到微服务架构演化
cover: false
date: 2024-01-08 10:43:26
tags:
categories:
 - [软件工程,架构设计,微服务]
top:
coverImg:
---
# 1. 现存的单体服务架构 

[[软件设计]] [[系统架构]]单体架构优势 ：
1. 应用开发简单，只需要构建单一应用
2. 易于针对应用程序作大规模的修改
3. 测试相对简单而直观，只需要进行端对端的测试，启动程序测试api
4. 易于横向扩展，可以部署多个实例进行负载均衡的服务调度

单体架构的缺陷：

1. 过度的复杂性，研发要理解架构的全部，修复和新增功能都变得耗时费力，并因此造成恶性循环 ，因为更改的难度增加，每次的更改都会使得项目变得更加复杂，难懂
2. 难以扩展，不同模块针对不同资源需求相互冲突，例如库存数据可以保存在一个大型的内存数据库中，理想情况下该服务应该具备一个较大的内存性能，而图片处理服务又需要较快的cpu来进行完成运算，这些不同的模块附着在一个系统的内部，系统针对服务器的必须同时满足所有的条件，又或者因为某个条件不满足对相应模块的性能造成拖累。 

单体架构图：

{% asset_img image.png 配置图 %}
	 
# 2. 从传统分层式架构风格转向[[微服务]]架构

## 2.1传统MVC 系统分层

按照软件元素层来进行划分，每个层都具备独立的逻辑和明确定义的指责。相互之间还存在的一定的依存关系。

- 表现层 ： 包含实现用户界面和外部api的代码
- 业务逻辑层 ： 包含业务逻辑
- 数据持久层 ： 实现数据交互逻辑

这之间存在着明显的一些弊端

- 单个表现层无法满足应用程序不止是单个系统调用的情况
- 单一数据持久层 无法实现应用程序多个数据库交互的事实
- 将业务逻辑层依赖于数据持久层 ： 将领域模型和数据模型进行混淆，将逻辑视图和数据视图混淆，会严重的影响业务的扩展能力。

要摆脱这些限制，所设计的架构风格核心上要把业务逻辑和表现层和数据访问层的逻辑进行分离 。

## 2.2 微服务架构演进

为满足服务的扩展性需求，服务的扩展服务架构，可以描述成为一个非常有用的三维扩展结构：

{% asset_img image-1.png 配置图 %}

在这个模型中包含了三种的扩展纬度 
- X轴扩展：在多个实例之间的负载均衡

- Z轴扩展：需要运营单体应用程序的多个实例，与负载均衡不同的是，每个实例本质上只负责数据的一个子集，通常方法是根据用户userID来进行路的分发工作，根据userID的头部信息在应用程序中选择其中一个。对于应用程序需要处理增加数据量的时候是个较好的方式

- Y轴扩展：x轴和z轴可以有效的增加吞吐量和可用性，然后这两种方式都没有解决日益增长的开发问题和应用复杂问题 。所以需要进行Y轴的扩展进行功能分解。把单体应用构建成一组服务。


{% asset_img image-2.png 配置图 %}


使大型复杂应用程序可以持续交付和持续部署 ，微服务架构包含了持续交付和持续部署的可测试性，可部署性以及开发团队自主松散耦合。演进后的微服务架构如下：


{% asset_img image-3.png 配置图 %}

- 每个服务都相对较小而易于维护，开发者容易理解服务，提升工作效率
- 服务可以独立部署，无论使用X轴扩展实例的克隆，还是Z轴的流量分区。每个服务都可以部署在适合的服务上。这和单体应用选择硬件截然不同。
- 更好的容错性，微服务的架构可以实现故障的隔离，某个服务的内存泄露不会造成其他服务的影响，相比单体应用的单一故障都可能拖垮整个应用，但是多服务之间要注意可能存在的雪崩效应。
- 更容易实验和采纳新的技术方案。微服务的架构可以消除对某项技术的长期依赖。原则上开发新的服务可以自由选择使用这个服务的任何语言和框架。当每个服务相对较小，使用更好的编程语言和技术来重写一个服务就会变得可能。针对一个新的技术尝试的失败也不至于带来整体的风险。


# 3. 微服务升级实现方案 

# 3.1  微服务的拆分和定义

通常考虑到服务的拆分，考虑根据业务进行划分通过梳理业务 ，首先进行了业务模块的纵向拆分，其拆分逻辑如下所示：

- 原子服务：业务对象定义，可以是一个单表，也可以是几个相关表，总之是一组在完整性上是不可拆分的数据，实现时要将事务异常向上抛出，确保事务完整。也可以指Kafka、Redis Proxy、ElasticSearch等其他外部数据资源。
- 单元服务：实现中心内部的业务功能，由一个到多个本中心原子服务组成。可以捕获原子服务的异常，对异常进行友好处理并返回错误代码及提示信息给调用者。
- 功能服务：功能服务一般由一个或多个单元服务构成。实现逻辑只限于输入输出参数转换，校验（可以调用校验类的单元服务），以及条件分支判断，即如何调用不同的单元服务。

在服务拆分时，先从业务角度确定拆分的方案。拆分的边界要充分考虑业务的独立性和专业性，比如客户触点类服务、营销类服务等，按服务的业务功能合理地划出拆分边界。

# 3.1 微服务架构实现图

{% asset_img image-4.png 配置图 %}

**服务拆解目标**
- web端前后端分离；
- 业务解耦：docker容器内部署应用的微服务组件；
- 服务端使用SpringBoot作为构建基础微服务框架，使得开发部署极其简单；
- 开放平台网关采取OAuth2.0认证标准，第三方系统基于JWT安全认证；
- 所有服务基于Restful做到无状态；
- 所有服务部署到docker集群中，资源动态伸缩，异常崩溃自动恢复；
- 使用sentinel做服务熔断降级处理，避免单个服务不可用引起系统雪崩，保障系统的高可用。

## 3.2 微服务[[系统架构]]说明 
微服务中提供了多重的业务支持，包含了业务逻辑，业务数据，业务模型等方面。

### 3.2.1  应用展示前台 
前后端剥离，服务端支持前台的多种展示形式 。

### 3.2.2  通信网关
支持服务发现、服务路由以及协议代理等，同时包含监控、ssl接入、服务模块化等功能，所有服务统一接入口。负责认证拦截，权限控制，服务限流，API管理。

- 服务限流 ： 主要以流量为切入点，从限流、流量整形、熔断降级、系统负载保护、热点防护等多个维度来帮助开发者保障微服务的稳定性。

- 认证拦截 ： 根据统一认证中心，针对分布式应用，做好统一会话管理和拦截工作，解决在微服务架构下会话一致性等问题 

- ACL控制 ： 应用在路由器接口的指令列表。针对微服务架构下合法访问控制列表，这些指令列表用来告诉路由器哪些数据包可以收、哪些数据包需要拒绝。至于数据包是被接收还是拒绝，可以由类似于源地址、目的地址、端口号等的特定指示条件来决定。 

- 路由管理：通过一系列谓词和过滤器的组合为微服务模块配置了路由规则，在微服务平台，除了配置静态路由配置，还实现动态路由，根据一定的路由规则实现路由的动态切换。

- API管理 ： 利用微服务平台提供的接口数据写入工具以及简单的点击操作就可以实现接口的管理，并通过通信网关统一进行发布和实现。

### 3.2.3 核心业务域
- 站点资源管理：为全市各级各部门提供了一个集数据采集、数据编辑、数据审核和信息发布为一体的网站工作管理平台
- 政府信息公开：为全市各级各部门政府网站信息公开提供信息编辑、审核和发布展示功能。
- 网上办事：实现网上办事的在线申报、指南、表格下载、在线咨询、办事投诉、常见问题解答等业务的综合办事服务。
- 互动交流：实现政府门户网站在线访谈、信箱管理、网上咨询投诉、民意征集、建言献策、网上留言、在线调查等应用功能，满足政府机关通过门户与广大公众进行在线互动和交流的一体化需求
- 重大建设项目：实现全市重大项目信息维护，内容公开及监察功能。
- 政务新媒体：提供新媒体信息采编、审核、发布及统计功能。
- 部门定制应用：各部门定制业务应用 

### 3.2.4 基础服务域 
- 组织机构服务：负责平台组织机构的管理，提供注册、变更、注销、获取组织机构信息及目录权限配置服务。
- 用户管理服务：负责平台用户信息的管理，提供注册、变更、停用、注销及获取用户信息服务。
- 身份认证服务：基于用户、设备、业务的认证、授权服务，包含单点登录。
- 权限管理服务：用户创建角色，权限，绑定角色权限，分配用户权限等服务业务 。
- 流程代理人服务： 提供流程代理人添加、删除、检查是否代理人、获取代理人服务、
- 短信服务：统一对接短信通道，维护短信模板，通信，溯源，并确认提供详尽完善的短信服务支持
- 邮件服务：统一对接各种短信协议，支撑业务电子邮件平台，维护邮箱模板等功能模块 
- 全文检索服务：提供索引的维护，映射的构建 ，数据的导入，各种组合搜索查询，聚合查询服务 

### 3.2.5 开放域
开放平台为第三方开发者提供了一个便捷的接入平台，基于Oauth2.0协议，富含丰富的API，帮助开发者定制开发企业应用。基于平台开放能力，可以帮助第三方快速、 低成本的开发，实现生产、管理、协作、运营的数字化，满足个性化需求。
- 应用管理服务： 第三方应用接入基础信息进行维护管理工作 。 
- 应用授权服务： 针对内部资源，进行能力化设计，并对于第三方应用接入进行授权工作。
- 应用资源服务：通过网关代理对外提供能力服务。在网关层需要对外部调用进行账号的创建、授权以及流量的管控，包括内部以及外部合作厂商应用级能力的调用。

### 3.2.5 支撑平台层


#### 3.2.5.1 分布式调度系统

分布式调度系统具备单机调度系统所不具备的优势，
单机版的定式任务调度只能在一台机器上运行，如果程序或者系统出现异常就会导致功能不可用。虽然可以在单机程序实现的足够稳定，但始终有机会遇到非程序引起的故障，而这个对于一个系统的核心功能来说是不可接受的。分布式调度服务可以保证定时任务的高可用。
其次，分布式调度可以解决单机性能瓶颈问题，一旦调度服务业务倍增，无法即时相应业务的诉求，就会导致服务进入瘫痪的和锁死的状况，采用分布式调度服务就能任意控制和分配服务资源针对不同的业务随时采用灵活策略进行服务调度

#### 3.2.5.2 分布式对象存储服务
对象存储（Object-based Storage)是一种新的网络存储架构，基于对象存储技术的设备就是对象存储设备（Object-based Storage Device）简称OSD
核心是将数据通路（数据读或写）和控制通路（元数据）分离，并且基于对象存储设备构建存储系统，每个对象存储设备具有一定的只能，能够自动管理其上的数据分布。对象存储结构由对象、对象存储设备、元数据服务器、对象存储系统的客户端四部分组成。
统一通信平台的对象存储采用分布式，可扩展，高容错的技术方案，保障数据的安全性和有效性，并针对对象操作提供一些列便捷操作 

#### 3.2.5.3 搜索引擎 

全文检索系统可以以各种计算机数据诸如文字，图像，声音等数据作为主要处理对象，基于文内的标引，使用自然语言进行检索的技术。与普通的数据库查询不同，全文检索不仅要查询结构化数据，还要对非结构化的数据进行高效查询 ，比起传统索引方式，全文索引提供了全新的，强大的检索方式 ，方便从多角度和和多层面的综合的提高信息的利用率 。


#### 3.2.5,4 工作流引擎 

工作流引擎提供丰富的应用接口，以支持系统的二次开发及管理、维护，支持“以流程为中心”的企业应用集成的框架。工作流引擎借助于一个或多个工作流状态机，激活并解释过程定义的全部或部分，并同外部的应用程序进行交互，完成工作流过程实例的创建、执行与管理，为工作流程的运行提供一个运行时环境。流程管理及监控提供对工作流的运行实例、活动实例的状态情况进行监控和管理，如挂起、重启动、终止某个过程实例。


#### 3.2.5.5 视图展示引擎
提供了数据的业务视图，对外提供了支撑视图的获取，筛选，过滤，展示等聚合功能。


### 3.2.6 底层平台

#### 3.2.6.1 底层平台组件列表 

- 关系型数据库 ： [[Oracle]]

- NoSQL数据库 ： [[mongoDB]] ，[[Hbase]]

- 分布式文件系统： [[MinIO]]

- 分布式缓存服务 ： [[Redis]] Cluster 

- 消息中间件 ： [[RabbitMQ]]

#### 3.2.6.2 底层平台功能说明

- 关系型数据库：采用了关系模型来组织数据的数据库，其以行和列的形式存储数据，以便于用户理解，关系型数据库这一系列的行和列被称为表，一组表组成了数据库。支持的数据源类型包括：Oracle,PGSQL等主流的关系型数据库。

- 非关系型数据库： 泛指非关系型的数据库。去掉关系数据库的关系型特性。数据之间无关系，这样就非常容易扩展。无形之间也在架构的层面上带来了可扩展的能力。大数据量，高性能，NoSQL数据库都具有非常高的读写性能，尤其在大数据量下，同样表现优秀。这得益于它的无关系性，数据库的结构简单。

- 缓存服务：分布式缓存服务，专注于提供即开即用、安全可靠、弹性扩容、便捷管理的在线分布式缓存能力。

- 消息队列： 构建实时数据管道和数据流应用。是在消息的传输过程中保存消息的容器。通过生产者、消费者模型。生产者不断向消息队列中生产消息，消费者不断的从队列中获取消息。因为消息的生产和消费都是异步的，而且只关心消息的发送和接收，没有业务逻辑的侵入，这样就实现了生产者和消费者的解耦。

- 分布式文件： 分布式文件系统把大量数据分散到不同的节点上存储，大大减小了数据丢失的风险。分布式文件系统具有冗余性，部分节点的故障并不影响整体的正常运行，而且即使出现故障的计算机存储的数据已经损坏，也可以由其它节点将损坏的数据恢复出来。因此，安全性是分布式文件系统最主要的特征。

### 3.2.7 微服务集群化管理 

#### 3.2.7.1 微服务集群化管理组件

- 分布式系统网关：Spring Cloud Gateway

- 分布式协调系统：Spring Cloud Alibaba Nacos Server

- 分布式配置中心：Spring Cloud Alibaba [[nacos]] Config

- 分布式熔断降级：Spring Cloud Alibaba [[Sentinel]]

- 分布式事务： [[Seata]]

- 分布式消息系统 ： [[RocketMQ]]

- 服务调用链监控 ： [[pinpoint]]

- 分布式日志收集 ： [[logstash]]

- 分布式搜索引擎 ： [[Elasticsearch]]

- 日志分析看板 ：[[Kibana]]

#### 3.2.7.2 微服务集群化管理说明 

- 服务注册和发现：服务注册到统一的信息平台，客户端向服务端注册自己的服务信息，同时将服务端的服务信息缓存到本地。客户端会和服务端周期性的进行心跳交互，以更新服务租约和服务信息。
- 统一的配置中心管理 ： 集中信息配置，并实时同步修改的信息
- 应用日志的监控： 统一应用日志管理 
- 系统性能监控：宿主机性能监控
- 服务可用性监控：服务探针保障服务可用性。
- 服务性能指标监控：单体服务性能指标监控
- 服务调用链回溯 ： 分布式事务跟踪系统的平台，用于基于java的大规模分布式系统，通过跟踪分布式应用之间的调用来提供解决方案，以帮助分析系统的总体结构和内部模块之间如何相互联系。
- 服务熔断 ： 为了保证其高可用，单个服务通常会集群部署。由于网络原因或者自身的原因，服务并不能保证100%可用，如果单个服务出现问题，调用这个服务就会出现线程阻塞，此时若有大量的请求涌入，Servlet容器的线程资源会被消耗完毕，导致服务瘫痪。服务与服务之间的依赖性，故障会传播，会对整个微服务系统造成灾难性的严重后果，为避免雪崩效应引入的服务熔断。


### 3.2.8 容器化管理

#### 3.2.8.1 容器管理组件

- [[Docker]] ： 平台管理的基础单元是容器。

- [[Kubernetes]]: 分布式资源调度平台服务编排 

- [[cAdvisor]] : 容器监控 

- [[Zabbix]]：系统监控 

- [[Prometheus]]：集群监控

- Kuboard ：  Kubernetes 图形化管理工具

- [[Grafana]]： 可视化大型测量数据的开源程序

#### 3.2.8.2 容器管理功能说明

本次方案中将客服应用侧的各类功能解耦，部署于docker容器中，容器技术的重要特点可有效的改善传统应用部署中衍生的重复建设、周期过长、复用性差等问题。

微服务以docker镜像的形式发布，运行在docker引擎下的容器中。Docker的优点是能够使用镜像，快速创建新的容器，以实现服务的随需运行，比虚机的方式更灵活。

采用kubernetes对容器进行编排，进行容器云的集中管理，Kubernetes中的大部分概念如Node、Pod、Replication Controller、 Service等都可以被看作一种资源对象，几乎所有资源对象都可以通过 Kubernetes提供的kubectl工具(或者API编程调用)执行增、删、改、查 等操作并将其保存在etcd中持久化存储。

采用kuboard对容器编排进行图形化管理， 作为一个Kubernetes 图形化管理工具，Kuboard 力图帮助用户快速在 Kubernetes 上落地微服务。



#### 3.2.8.3统一通信网关服务 

- 服务限流 ： 主要以流量为切入点，从限流、流量整形、熔断降级、系统负载保护、热点防护等多个维度来帮助开发者保障微服务的稳定性。

- 认证拦截 ： 根据统一认证中心，针对分布式应用，做好统一会话管理和拦截工作，解决在微服务架构下会话一致性等问题 

- ACL控制 ： 应用在路由器接口的指令列表。针对微服务架构下合法访问控制列表，这些指令列表用来告诉路由器哪些数据包可以收、哪些数据包需要拒绝。至于数据包是被接收还是拒绝，可以由类似于源地址、目的地址、端口号等的特定指示条件来决定。 

- 路由管理：通过一系列谓词和过滤器的组合为微服务模块配置了路由规则，在微服务平台，除了配置静态路由配置，还实现动态路由，根据一定的路由规则实现路由的动态切换。

- API管理 ： 利用微服务平台提供的接口数据写入工具以及简单的点击操作就可以实现接口的管理，并通过通信网关统一进行发布和实现。


#### 3.2.8.4 容器化管理组件 

- Docker ： 平台管理的基础单元是容器。

- Kubernetes: 分布式资源调度平台服务编排 

- cAdvisor : 容器监控 

- Zabbix：系统监控 

- Prometheus：集群监控

- Kuboard ：  Kubernetes 图形化管理工具

- Grafana： 可视化大型测量数据的开源程序


#### 3.2.8.5 微服务集群管理 

- 分布式系统网关：Spring Cloud Gateway

- 分布式协调系统：Spring Cloud Alibaba Nacos Server

- 分布式配置中心：Spring Cloud Alibaba Nacos Config

- 分布式熔断降级：Spring Cloud Alibaba Sentinel

- 分布式事务： Seata

- 分布式消息系统 ： RocketMQ

- 服务调用链监控 ： PinPoint

- 分布式日志收集 ： logstash

- 分布式搜索引擎 ： ElasticSearch

- 日志分析看板 ： Kibana


#### 3.2.8.6 底层平台 

- 关系型数据库 ： Oracle

- NoSQL数据库 ： Mongodb ，Hbase

- 分布式文件系统： Minio

- 分布式缓存服务 ： Redis Cluster 

- 消息中间件 ： RabbitMQ



